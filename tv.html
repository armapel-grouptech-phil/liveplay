<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liveplay for TV</title>
    <script>
        (function() {
            const userAgent = navigator.userAgent;
            const isTvDevice = /TV|Tizen|Web0S|Bravia|Viera|SMART-TV|SmartTV|AppleTV|GoogleTV|Roku|CrKey|AFT/i.test(userAgent);

            if (!isTvDevice) {
                window.location.href = '/404';
            }
        })();
    </script>
    <link rel="icon" type="image/png" href="/logo/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/logo/favicon.svg" />
    <link rel="shortcut" href="/logo/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/logo/apple-touch-icon.png" />
    <link rel="manifest" href="/logo/site.webmanifest" />
    <link href="https://fonts.cdnfonts.com/css/tt-hoves-pro-trial" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,200,0..1,0" />
    <script src="https://ajax.googleapis.com/ajax/libs/shaka-player/4.3.4/shaka-player.ui.js"></script>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/shaka-player/4.3.4/controls.css">
    <style>
    body, html {
        margin: 0; padding: 0; width: 100%; height: 100%;
        background-color: #000; color: #fff;
        font-family: 'TT Hoves Pro Trial', sans-serif;
        overflow: hidden; user-select: none; 
        cursor: none;
        pointer-events: none;
    }
    
    #video-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
    video { width: 100%; height: 100%; }

    #fade-overlay {
        content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: linear-gradient(to bottom, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 25%, rgba(0,0,0,0) 75%, rgba(0,0,0,0.9) 100%);
        z-index: 2; pointer-events: none; opacity: 0; transition: opacity 0.5s ease-in-out;
    }
    #fade-overlay.show { opacity: 1; }

    #liveplay-logo, #channel-info, #live-indicator-corner {
        position: absolute;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
        z-index: 3;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
    }
    #liveplay-logo { left: 50px; top: 40px; font-size: 2.5em; font-weight: 600; }
    #channel-info { left: 50px; bottom: 40px; }
    #liveplay-logo.show, #channel-info.show, #live-indicator-corner.show { opacity: 1; }
    
    #channel-name { font-size: 3em; margin: 0; }
    #channel-category { font-size: 1.5em; margin: 5px 0 0 0; color: #ccc; }

    #sidebar {
        position: fixed; top: 0; left: 0; width: 420px; height: 100%;
        background-color: rgba(10, 10, 10, 0.9);  backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px); border-right: 2px solid #333;
        z-index: 50; display: flex; flex-direction: column;
        transform: translateX(-100%); transition: transform 0.3s ease-in-out;
    }
    
    #sidebar.show { 
        transform: translateX(0); 
        pointer-events: auto;
    }

    .sidebar-header {
        display: flex; justify-content: space-between; align-items: center;
        padding: 25px 30px; border-bottom: 2px solid #333; background-color: #000;
    }
    .sidebar-logo { font-size: 2em; font-weight: bold; }
    #time-date { font-size: 1.2em; color: #ccc; }
    #channel-list-container {
        list-style: none; padding: 0; margin: 0; flex-grow: 1; overflow-y: auto;
        scrollbar-width: thin; scrollbar-color: #555 #222;
    }
    #channel-list-container::-webkit-scrollbar { width: 8px; }
    #channel-list-container::-webkit-scrollbar-track { background: #222; }
    #channel-list-container::-webkit-scrollbar-thumb { background-color: #555; border-radius: 6px; }
    
    #channel-list-container li {
        display: flex; justify-content: space-between; align-items: center;
        padding: 20px 30px; font-size: 1.4em; border-bottom: 1px solid #222;
        transition: background-color 0.2s ease;
        cursor: default;
    }
    #channel-list-container li.focused { background-color: #ff4d00; color: #fff; }
    
    #live-indicator-corner {
        display: flex; align-items: center; gap: 8px;
        color: #ff4d00; font-weight: 200; font-size: 1.5rem;
        bottom: 40px; right: 50px;
    }
    .sidebar-live-icon { color: #ff4d00; }
    #channel-list-container li.focused .sidebar-live-icon { color: #fff; }
    .material-symbols-outlined { font-size: inherit !important; }

    #exit-popup-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        display: flex; align-items: center; justify-content: center; z-index: 100;
        opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
    }
    
    #exit-popup-overlay.show { 
        opacity: 1; 
        pointer-events: auto; 
    }

    .exit-popup {
        background-color: #111; padding: 40px 60px; border-radius: 10px;
        text-align: center; border: 1px solid #444;
    }
    .exit-popup h2 { margin-top: 0; font-size: 2.5em; font-weight: 600; }
    .exit-buttons button {
        background-color: #333; color: white; border: 2px solid #555; padding: 15px 40px;
        font-size: 1.5em; font-family: 'TT Hoves Pro Trial', sans-serif; border-radius: 5px;
        margin: 0 20px; 
        cursor: default;
        transition: transform 0.2s ease, background-color 0.2s ease;
    }
    .exit-buttons button:focus {
        background-color: #ff4d00; color: #fff;
        outline: none; transform: scale(1.05);
    }
</style>
</head>
<body>
    <div id="sidebar">
        <div class="sidebar-header">
            <strong class="sidebar-logo">liveplay</strong>
            <span id="time-date"></span>
        </div>
        <ul id="channel-list-container"></ul>
    </div>

    <div id="fade-overlay"></div>
    <div id="liveplay-logo"><strong>liveplay</strong></div>
    <div id="video-container"><video id="video" poster="" autoplay></video></div>

    <div id="channel-info">
        <h1 id="channel-name">Loading...</h1>
        <p id="channel-category"></p>
    </div>

    <div id="live-indicator-corner">
        <span class="material-symbols-outlined">sensors</span> LIVE
    </div>

    <div id="exit-popup-overlay">
        <div class="exit-popup">
            <h2>Exit Liveplay?</h2>
            <div class="exit-buttons">
                <button id="exit-cancel-btn">Cancel</button>
                <button id="exit-confirm-btn">Exit</button>
            </div>
        </div>
    </div>

    <script>
        let channelList = [];
        let currentChannelIndex = 0;
        let infoTimeout;
        let isExitPopupActive = false;
        let isSidebarActive = false;
        let currentFocusIndex = 0;

        const video = document.getElementById('video');
        const fadeOverlay = document.getElementById('fade-overlay');
        const liveplayLogo = document.getElementById('liveplay-logo');
        const channelInfo = document.getElementById('channel-info');
        const channelName = document.getElementById('channel-name');
        const channelCategory = document.getElementById('channel-category');
        const liveIndicatorCorner = document.getElementById('live-indicator-corner');
        const exitPopupOverlay = document.getElementById('exit-popup-overlay');
        const exitConfirmBtn = document.getElementById('exit-confirm-btn');
        const exitCancelBtn = document.getElementById('exit-cancel-btn');
        const sidebar = document.getElementById('sidebar');
        const channelListContainer = document.getElementById('channel-list-container');
        const timeDateElement = document.getElementById('time-date');
        let player;

        async function init() {
            try {
                const response = await fetch('/api/getChannels.js');
                if (!response.ok) throw new Error('Network response was not ok');
                channelList = await response.json();

                shaka.polyfill.installAll();
                if (shaka.Player.isBrowserSupported()) await initPlayer();
                else console.error('Browser not supported!');

                document.addEventListener('keydown', handleKeyPress);
                exitConfirmBtn.addEventListener('click', handleExitConfirm);
                exitCancelBtn.addEventListener('click', handleExitCancel);

                populateChannelList();
                updateTimeDate();
                setInterval(updateTimeDate, 1000);
            } catch (error) {
                console.error("Failed to fetch channel list:", error);
                channelName.textContent = "Error";
                channelCategory.textContent = "Could not load channels.";
            }
        }

        async function initPlayer() {
            player = new shaka.Player(video);
            player.configure('ui.enabled', false);
            player.addEventListener('error', onErrorEvent);
            await loadChannel(channelList[currentChannelIndex]);
            showAndHideInfo();
        }

        async function loadChannel(channel) {
            if (!channel) return;

            updateChannelInfo(channel);

            try {
                const streamResponse = await fetch(`/api/getStream.js?name=${encodeURIComponent(channel.name)}`);
                if (!streamResponse.ok) throw new Error(`Stream for ${channel.name} not found`);
                const streamData = await streamResponse.json();
                
                if (player.getMediaElement()) await player.unload();
            
                player.configure('drm', { clearKeys: {} });
                if (streamData.clearKey) {
                    player.configure({ drm: { clearKeys: streamData.clearKey } });
                }

                await player.load(streamData.manifestUri);
            } catch (error) {
                console.error(`Failed to load stream for ${channel.name}:`, error);
            }
        }

        function updateChannelInfo(channel) {
            channelName.textContent = channel.name;
            channelCategory.textContent = channel.category;
        }

        function showAndHideInfo() {
            fadeOverlay.classList.add('show');
            liveplayLogo.classList.add('show');
            channelInfo.classList.add('show');
            liveIndicatorCorner.classList.add('show');
            clearTimeout(infoTimeout);
            infoTimeout = setTimeout(() => {
                fadeOverlay.classList.remove('show');
                liveplayLogo.classList.remove('show');
                channelInfo.classList.remove('show');
                liveIndicatorCorner.classList.remove('show');
            }, 4000);
        }
        
        function handleKeyPress(event) {
            event.preventDefault();
            if (isExitPopupActive) {
                const currentFocus = document.activeElement;
                if (event.keyCode === 37) { if (currentFocus === exitConfirmBtn) exitCancelBtn.focus(); } 
                else if (event.keyCode === 39) { if (currentFocus === exitCancelBtn) exitConfirmBtn.focus(); } 
                else if (event.keyCode === 13) { currentFocus.click(); } 
                else if (event.keyCode === 8 || event.keyCode === 461 || event.keyCode === 10009) { handleExitCancel(); }
            } else if (isSidebarActive) {
                switch (event.keyCode) {
                    case 38: currentFocusIndex = Math.max(0, currentFocusIndex - 1); updateFocus(); break;
                    case 40: currentFocusIndex = Math.min(channelList.length - 1, currentFocusIndex + 1); updateFocus(); break;
                    case 13: selectChannelFromList(); break;
                    case 37: case 8: case 461: case 10009: hideSidebar(); break;
                }
            } else {
                switch (event.keyCode) {
                    case 38: changeChannel(1); break;
                    case 40: changeChannel(-1); break;
                    case 39: showSidebar(); break;
                    case 8: case 461: case 10009: showExitPopup(); break;
                }
            }
        }

        function changeChannel(direction) {
            currentChannelIndex = (currentChannelIndex + direction + channelList.length) % channelList.length;
            loadChannel(channelList[currentChannelIndex]);
            showAndHideInfo();
        }

        function populateChannelList() {
            channelListContainer.innerHTML = '';
            channelList.forEach((channel, index) => {
                const li = document.createElement('li');
                li.dataset.index = index;
                li.innerHTML = `
                    <span>${channel.name}</span>
                    <span class="sidebar-live-icon">
                        <span class="material-symbols-outlined">sensors</span>
                    </span>
                `;
                channelListContainer.appendChild(li);
            });
        }

        function showSidebar() {
            isSidebarActive = true;
            currentFocusIndex = currentChannelIndex;
            sidebar.classList.add('show');
            updateFocus();
        }

        function hideSidebar() {
            isSidebarActive = false;
            sidebar.classList.remove('show');
        }

        function updateFocus() {
            const items = channelListContainer.getElementsByTagName('li');
            Array.from(items).forEach(item => item.classList.remove('focused'));
            const focusedElement = items[currentFocusIndex];
            if (focusedElement) {
                focusedElement.classList.add('focused');
                focusedElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function selectChannelFromList() {
            if (currentChannelIndex !== currentFocusIndex) {
                currentChannelIndex = currentFocusIndex;
                loadChannel(channelList[currentChannelIndex]);
                showAndHideInfo();
            }
            hideSidebar();
        }

        function updateTimeDate() {
            const now = new Date();
            const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const date = now.toLocaleDateString([], { month: 'short', day: 'numeric' });
            timeDateElement.textContent = `${date}, ${time}`;
        }
        
        function showExitPopup() {
            isExitPopupActive = true;
            exitPopupOverlay.classList.add('show');
            exitCancelBtn.focus();
        }

        function hideExitPopup() {
            isExitPopupActive = false;
            exitPopupOverlay.classList.remove('show');
        }

        function handleExitConfirm() { window.close(); }
        function handleExitCancel() { hideExitPopup(); }
        function onErrorEvent(event) { onError(event.detail); }
        function onError(error) { console.error('Shaka Player Error:', error.code, 'object', error); }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
