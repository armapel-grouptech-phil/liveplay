<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Supabase Realtime Test</title>
</head>
<body>
    <h1>Supabase Realtime Test Page</h1>
    <p>Open the console (F12) to see logs.</p>
    <p>Pairing Code will appear below:</p>
    <h2 id="code-display">----</h2>

    <!-- Supabase Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // --- PASTE YOUR KEYS HERE ---
        const SUPABASE_URL = 'YOUR_PROJECT_URL'; 
        const SUPABASE_ANON_KEY = 'YOUR_ANON_PUBLIC_KEY'; 

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const codeDisplay = document.getElementById('code-display');
        let pairingCode;

        console.log("Test page loaded. Initializing Supabase...");

        async function runTest() {
            // 1. Create a room
            try {
                pairingCode = Math.floor(1000 + Math.random() * 9000);
                const { error } = await supabaseClient.from('rooms').insert({ id: pairingCode });
                if (error) {
                    // If this error shows, it is 100% an RLS or API key issue.
                    console.error("CRITICAL ERROR creating room:", error);
                    alert("ERROR: Could not create room. Check RLS or API Keys. Error: " + error.message);
                    return;
                }
                codeDisplay.textContent = pairingCode;
                console.log(`Room ${pairingCode} created. Now listening for changes...`);
            } catch (err) {
                console.error("A fatal error occurred:", err);
                return;
            }

            // 2. Listen for changes to that room
            supabaseClient.channel(`room-${pairingCode}`)
                .on('postgres_changes', 
                    { 
                        event: 'UPDATE', 
                        schema: 'public', 
                        table: 'rooms', 
                        filter: `id=eq.${pairingCode}` 
                    },
                    (payload) => {
                        console.log("CHANGE DETECTED!", payload.new);
                        // If you see this alert, REALTIME IS WORKING!
                        alert(`SUCCESS! Realtime message received! Status is now: ${payload.new.status}`);
                    }
                )
                .subscribe((status) => {
                    if (status === 'SUBSCRIBED') {
                        console.log(`Successfully subscribed to room ${pairingCode}. Waiting for manual update in Supabase dashboard.`);
                    } else {
                        console.error("Failed to subscribe. Status:", status);
                    }
                });
        }

        runTest();
    </script>
</body>
</html>
